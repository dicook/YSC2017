<!DOCTYPE html>
<html>
  <head>
    <title>Young Statisticians Workshop: Developing Your Career to Thrive in a Data-rich, Technology-driven, Reproducible Research Environment</title>
    <meta charset="utf-8">
    <meta name="author" content="Di Cook (dicook@monash.edu, @visnut)" />
    <link href="2.data.organisation_files/remark-css-0.0.1/example.css" rel="stylesheet" />
    <link rel="stylesheet" href="myremark.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Young Statisticians Workshop: Developing Your Career to Thrive in a Data-rich, Technology-driven, Reproducible Research Environment
## Organising data
### Di Cook (<a href="mailto:dicook@monash.edu">dicook@monash.edu</a>, <span class="citation">@visnut</span>)
### 25/9/2017

---






# Overview

- Terminology of statistical data exploration
- Process of exploring data
- Tidy vs messy data
- Tidying data process
- Wrangling your data

---
# Exploratory data analysis

"Data science is an exciting discipline that allows you to turn raw data into understanding, insight, and knowledge." [Grolemund and Wickham](http://r4ds.had.co.nz/introduction.html) 

Exploratory data analysis is the stage in the analysis where the analyst "plays in the sand" with their data to see what it has to tell them. It allows us to find the unexpected, and come to some understanding of the information that the data contains. [Cook and Swayne](http://www.ggobi.org/book/)

---
# Exploring your data, stages

- import
- tidy
- transform/wrangle/clean
- visualise
- model
- communicate

---
# Rectangular data

- Variables are in the columns
  - A __variable__ is a quantity, quality, or property that you can measure.
  - A value is the state of a variable when you measure it. The value of a variable may change from measurement to measurement.
- Observations are in the rows: An __observation__ is a set of measurements made under similar conditions (you usually make all of the measurements in an observation at the same time and on the same object). An observation will contain several values, each associated with a different variable. I’ll sometimes refer to an observation as a data point.
- __Tabular data__ is a set of values, each associated with a variable and an observation. Tabular data is __tidy__ if each value is placed in its own "cell", each variable in its own column, and each observation in its own row.

---
# Tidying data

Here are a bunch of examples data sets that have come across my desk. We are going to work out what are the variables and what are the observations, to know what form we need to rearrange the data to get it into tidy form.

---
# Example 1

What are the variables? Observations?


```
# A tibble: 6 x 4
                      Inst AvNumPubs AvNumCits PctCompletion
                     &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;
1 ARIZONA STATE UNIVERSITY      0.90      1.57          31.7
2        AUBURN UNIVERSITY      0.79      0.64          44.4
3           BOSTON COLLEGE      0.51      1.03          46.8
4        BOSTON UNIVERSITY      0.49      2.66          34.2
5      BRANDEIS UNIVERSITY      0.30      3.03          48.7
6         BROWN UNIVERSITY      0.84      2.31          54.6
```

Is it in tidy form?

---
# Example 2 

What are the variables? Observations?


```
# A tibble: 3 x 12
      id `WI-6.R1` `WI-6.R2` `WI-6.R4` `WM-6.R1` `WM-6.R2` `WI-12.R1`
   &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
1 Gene 1  2.182424 2.2042219  4.195636 2.6273345  5.063641   4.540002
2 Gene 2  1.464224 0.5854472  1.859238 0.5152242  2.882808   1.364037
3 Gene 3  2.031792 0.8701078  3.281983 0.5330452  4.627315   2.182192
# ... with 5 more variables: `WI-12.R2` &lt;dbl&gt;, `WI-12.R4` &lt;dbl&gt;,
#   `WM-12.R1` &lt;dbl&gt;, `WM-12.R2` &lt;dbl&gt;, `WM-12.R4` &lt;dbl&gt;
```

---
# Example 3

What are the variables? Observations?


```
           V1   V2 V3   V4  V5  V9 V13 V17 V21 V25 V29 V33 V37 V41 V45 V49
1 ASN00086282 1970  7 TMAX 141 124 113 123 148 149 139 153 123 108 119 112
2 ASN00086282 1970  7 TMIN  80  63  36  57  69  47  84  78  49  42  48  56
3 ASN00086282 1970  7 PRCP   3  30   0   0  36   3   0   0  10  23   3   0
4 ASN00086282 1970  8 TMAX 145 128 150 122 109 112 116 142 166 127 117 127
5 ASN00086282 1970  8 TMIN  50  61  75  67  41  51  48  -7  56  62  47  33
6 ASN00086282 1970  8 PRCP   0  66   0  53  13   3   8   0   0   0   3   5
  V53 V57 V61 V65 V69 V73 V77 V81 V85 V89 V93 V97
1 126 112 115 133 134 126 104 143 141 134 117 142
2  51  36  44  39  40  58  15  33  51  74  39  66
3   5   0   0   0   0   0   8   0  18   0   0   0
4 159 143 114  65 113 125 129 147 161 168 178 161
5  67  84  11  41  18  50  22  28  74  94  73  88
6   0   0  64   3  99  36   8   0   0   0   8  36
```

---
# Example 4

What are the variables? Observations?


```
# A tibble: 6 x 22
   iso2  year  m_04 m_514 m_014 m_1524 m_2534 m_3544 m_4554 m_5564  m_65
  &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;  &lt;int&gt;  &lt;int&gt;  &lt;int&gt;  &lt;int&gt;  &lt;int&gt; &lt;int&gt;
1    ZW  2003    NA    NA   133    874   3048   2228    981    367   205
2    ZW  2004    NA    NA   187    833   2908   2298   1056    366   198
3    ZW  2005    NA    NA   210    837   2264   1855    762    295   656
4    ZW  2006    NA    NA   215    736   2391   1939    896    348   199
5    ZW  2007     6   132   138    500   3693      0    716    292   153
6    ZW  2008    NA    NA   127    614      0   3316    704    263   185
# ... with 11 more variables: m_u &lt;int&gt;, f_04 &lt;int&gt;, f_514 &lt;int&gt;,
#   f_014 &lt;int&gt;, f_1524 &lt;int&gt;, f_2534 &lt;int&gt;, f_3544 &lt;int&gt;, f_4554 &lt;int&gt;,
#   f_5564 &lt;int&gt;, f_65 &lt;int&gt;, f_u &lt;int&gt;
```

---
# Example 5


```
            religion &lt;$10k $10-20k $20-30k $30-40k
1           Agnostic    27      34      60      81
2            Atheist    12      27      37      52
3           Buddhist    27      21      30      34
4           Catholic   418     617     732     670
5 Don’t know/refused    15      14      15      11
```

---
# Example 6

10 week sensory experiment, 12 individuals assessed taste of french fries on several scales (how potato-y, buttery, grassy, rancid, paint-y do they taste?), fried in one of 3 different oils, replicated twice. First few rows:


```
   time treatment subject rep potato buttery grassy rancid painty
61    1         1       3   1    2.9     0.0    0.0    0.0    5.5
25    1         1       3   2   14.0     0.0    0.0    1.1    0.0
62    1         1      10   1   11.0     6.4    0.0    0.0    0.0
26    1         1      10   2    9.9     5.9    2.9    2.2    0.0
```

What is the experimental unit? What are the factors of the experiment? What was measured? What do you want to know?

---
# Messy data patterns

There are various features of messy data that one can observe in practice. Here are some of the more commonly observed patterns:

- Column headers are values, not variable names
- Variables are stored in both rows and columns, contingency table format
- One type of experimental unit stored in multiple tables
- Dates in many different formats
- Every messy data set, is messy in its own way

---
# What is tidy data?

- Each observation forms a row
- Each variable forms a column
- Data is contained in a single table
- Long form makes it easier to reshape in many different ways
- Wide form is common for analysis

---
# Tidy

Same pieces, many different constructions (analogy from Hadley Wickham)

![](images/lego1.jpg) 
![](images/lego2.jpg) 
![](images/lego3.jpg) 
![](images/lego4.jpg) 
![](images/lego5.jpg) 

[Alan Chia/Creative Commons](https://commons.wikimedia.org/wiki/File:Lego_Color_Bricks.jpg),  [dirkb86/Creative Commons](https://www.flickr.com/photos/dirkb86/8446019404/in/set-72157632691207934), 
[Joris/Creative Commons](https://www.wired.com/2012/08/dear-lego/), 
[brainbikerider/Creative Commons](https://amodularlife.wordpress.com/2010/07/26/new-sydney-opera-house-lego-set/),
[Otto Normalverbraucher/Creative Commons](https://commons.wikimedia.org/wiki/File:Lego_Chicago_City_View_2001.jpg)

---
# Messy 

Specialist pieces, limited options (analogy from Hadley Wickham)

![](images/playmobile1.jpg) [1971markus/Creative Commons](https://commons.wikimedia.org/wiki/File:Playmobil-Ochsenwagen-Modell_im_LWL-Römermuseum_in_Haltern.jpg)

![](images/playmobile2.jpg) [Angela V/Creative Commons](http://www.onesmileymonkey.com/reviews/toys-2/playmobils-adventure-tree-house-pickup-truck/)

---
# Tidy verbs

- `gather`: specify the **keys** (identifiers) and the **values** (measures) to make long form (used to be called melting)
- `spread`: variables in columns (used to be called casting)
- `nest`/`unnest`: working with list variables
- `separate`/`unite`: split and combine columns

---
# Tidying the example 2 data


```r
genes &lt;- read_csv("data/genes.csv")
head(genes)
# A tibble: 3 x 12
      id `WI-6.R1` `WI-6.R2` `WI-6.R4` `WM-6.R1` `WM-6.R2` `WI-12.R1`
   &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
1 Gene 1  2.182424 2.2042219  4.195636 2.6273345  5.063641   4.540002
2 Gene 2  1.464224 0.5854472  1.859238 0.5152242  2.882808   1.364037
3 Gene 3  2.031792 0.8701078  3.281983 0.5330452  4.627315   2.182192
# ... with 5 more variables: `WI-12.R2` &lt;dbl&gt;, `WI-12.R4` &lt;dbl&gt;,
#   `WM-12.R1` &lt;dbl&gt;, `WM-12.R2` &lt;dbl&gt;, `WM-12.R4` &lt;dbl&gt;
```

---
# Gather column names into long form


```r
gather(genes, variable, expr, -id) 
# A tibble: 33 x 3
       id variable      expr
    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;
 1 Gene 1  WI-6.R1 2.1824242
 2 Gene 2  WI-6.R1 1.4642236
 3 Gene 3  WI-6.R1 2.0317925
 4 Gene 1  WI-6.R2 2.2042219
 5 Gene 2  WI-6.R2 0.5854472
 6 Gene 3  WI-6.R2 0.8701078
 7 Gene 1  WI-6.R4 4.1956364
 8 Gene 2  WI-6.R4 1.8592378
 9 Gene 3  WI-6.R4 3.2819835
10 Gene 1  WM-6.R1 2.6273345
# ... with 23 more rows
```

---
# Separate columns


```r
genes %&gt;%
  gather(variable, expr, -id) %&gt;%
  separate(variable, c("trt", "leftover"), "-") 
# A tibble: 33 x 4
       id   trt leftover      expr
 *  &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;
 1 Gene 1    WI     6.R1 2.1824242
 2 Gene 2    WI     6.R1 1.4642236
 3 Gene 3    WI     6.R1 2.0317925
 4 Gene 1    WI     6.R2 2.2042219
 5 Gene 2    WI     6.R2 0.5854472
 6 Gene 3    WI     6.R2 0.8701078
 7 Gene 1    WI     6.R4 4.1956364
 8 Gene 2    WI     6.R4 1.8592378
 9 Gene 3    WI     6.R4 3.2819835
10 Gene 1    WM     6.R1 2.6273345
# ... with 23 more rows
```

---


```r
genes %&gt;%
  gather(variable, expr, -id) %&gt;%
  separate(variable, c("trt", "leftover"), "-") %&gt;%
  separate(leftover, c("time", "rep"), "\\.") 
# A tibble: 33 x 5
       id   trt  time   rep      expr
 *  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     &lt;dbl&gt;
 1 Gene 1    WI     6    R1 2.1824242
 2 Gene 2    WI     6    R1 1.4642236
 3 Gene 3    WI     6    R1 2.0317925
 4 Gene 1    WI     6    R2 2.2042219
 5 Gene 2    WI     6    R2 0.5854472
 6 Gene 3    WI     6    R2 0.8701078
 7 Gene 1    WI     6    R4 4.1956364
 8 Gene 2    WI     6    R4 1.8592378
 9 Gene 3    WI     6    R4 3.2819835
10 Gene 1    WM     6    R1 2.6273345
# ... with 23 more rows
```

---


```r
gtidy &lt;- genes %&gt;%
  gather(variable, expr, -id) %&gt;%
  separate(variable, c("trt", "leftover"), "-") %&gt;%
  separate(leftover, c("time", "rep"), "\\.") %&gt;%
  mutate(trt = sub("W", "", trt)) %&gt;%
  mutate(rep = sub("R", "", rep))
head(gtidy)
# A tibble: 6 x 5
      id   trt  time   rep      expr
   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     &lt;dbl&gt;
1 Gene 1     I     6     1 2.1824242
2 Gene 2     I     6     1 1.4642236
3 Gene 3     I     6     1 2.0317925
4 Gene 1     I     6     2 2.2042219
5 Gene 2     I     6     2 0.5854472
6 Gene 3     I     6     2 0.8701078
```

---
# Make a picture

&lt;img src="2.data.organisation_files/figure-html/unnamed-chunk-14-1.png" style="display: block; margin: auto;" /&gt;

---
# Tidying example 3


```r
melbtemp &lt;- read.fwf("data/ASN00086282.dly", 
                     c(11, 4, 2, 4, rep(c(5, 1, 1, 1), 31)), fill=T)
melbtemp &lt;- melbtemp[,c(1,2,3,4,seq(5,128,4))]
colnames(melbtemp) &lt;- c("id", "year", "month", "var", paste0("V",1:31))
head(melbtemp)
           id year month  var  V1  V2  V3  V4  V5  V6  V7  V8  V9 V10 V11
1 ASN00086282 1970     7 TMAX 141 124 113 123 148 149 139 153 123 108 119
2 ASN00086282 1970     7 TMIN  80  63  36  57  69  47  84  78  49  42  48
3 ASN00086282 1970     7 PRCP   3  30   0   0  36   3   0   0  10  23   3
4 ASN00086282 1970     8 TMAX 145 128 150 122 109 112 116 142 166 127 117
5 ASN00086282 1970     8 TMIN  50  61  75  67  41  51  48  -7  56  62  47
6 ASN00086282 1970     8 PRCP   0  66   0  53  13   3   8   0   0   0   3
  V12 V13 V14 V15 V16 V17 V18 V19 V20 V21 V22 V23 V24 V25 V26 V27 V28 V29
1 112 126 112 115 133 134 126 104 143 141 134 117 142 158 149 133 143 150
2  56  51  36  44  39  40  58  15  33  51  74  39  66  78  36  61  46  42
3   0   5   0   0   0   0   0   8   0  18   0   0   0   0  13   3   0  25
4 127 159 143 114  65 113 125 129 147 161 168 178 161 145 142 137 150 120
5  33  67  84  11  41  18  50  22  28  74  94  73  88  50  48  54  78  47
6   5   0   0  64   3  99  36   8   0   0   0   8  36  25  30  56   5  69
  V30 V31
1 145 115
2  63  39
3   0   3
4 114 129
5  18  39
6   3  20
```

---


```r
melbtemp %&gt;% 
  gather(day, value, V1:V31) %&gt;%
  head()
           id year month  var day value
1 ASN00086282 1970     7 TMAX  V1   141
2 ASN00086282 1970     7 TMIN  V1    80
3 ASN00086282 1970     7 PRCP  V1     3
4 ASN00086282 1970     8 TMAX  V1   145
5 ASN00086282 1970     8 TMIN  V1    50
6 ASN00086282 1970     8 PRCP  V1     0
```

---


```r
melbtemp %&gt;% 
  gather(day, value, V1:V31) %&gt;%
  mutate(day = sub("V", "", day)) %&gt;%
  head()
           id year month  var day value
1 ASN00086282 1970     7 TMAX   1   141
2 ASN00086282 1970     7 TMIN   1    80
3 ASN00086282 1970     7 PRCP   1     3
4 ASN00086282 1970     8 TMAX   1   145
5 ASN00086282 1970     8 TMIN   1    50
6 ASN00086282 1970     8 PRCP   1     0
```

---

Missing values have been coded as -9999. Need to recode these as NA.


```
    min median  max
1 -9999     91 1388
```


```r
melbtemp %&gt;% 
  gather(day, value, V1:V31) %&gt;%
  mutate(day = sub("V", "", day)) %&gt;%
  mutate(value=ifelse(value==-9999, NA, value)) %&gt;%
  head()
           id year month  var day value
1 ASN00086282 1970     7 TMAX   1   141
2 ASN00086282 1970     7 TMIN   1    80
3 ASN00086282 1970     7 PRCP   1     3
4 ASN00086282 1970     8 TMAX   1   145
5 ASN00086282 1970     8 TMIN   1    50
6 ASN00086282 1970     8 PRCP   1     0
```

---

There are more variables types that are recognisable:


```
# A tibble: 7 x 2
     var     n
  &lt;fctr&gt; &lt;int&gt;
1   DATN    62
2   DATX    31
3   MDTN    62
4   MDTX    31
5   PRCP 16399
6   TMAX 16399
7   TMIN 16399
```

---


```r
melbtemp %&gt;% 
  gather(day, value, V1:V31) %&gt;%
  mutate(day = sub("V", "", day)) %&gt;%
  mutate(value=ifelse(value==-9999, NA, value)) %&gt;%
  filter(var %in% c("PRCP", "TMAX", "TMIN")) %&gt;%
  head()
           id year month  var day value
1 ASN00086282 1970     7 TMAX   1   141
2 ASN00086282 1970     7 TMIN   1    80
3 ASN00086282 1970     7 PRCP   1     3
4 ASN00086282 1970     8 TMAX   1   145
5 ASN00086282 1970     8 TMIN   1    50
6 ASN00086282 1970     8 PRCP   1     0
```

---


```r
melbtemp %&gt;% 
  gather(day, value, V1:V31) %&gt;%
  mutate(day = sub("V", "", day)) %&gt;%
  mutate(value=ifelse(value==-9999, NA, value)) %&gt;%
  filter(var %in% c("PRCP", "TMAX", "TMIN")) %&gt;%
  spread(var, value) %&gt;%
  head()
           id year month day PRCP TMAX TMIN
1 ASN00086282 1970     7   1    3  141   80
2 ASN00086282 1970     7  10   23  108   42
3 ASN00086282 1970     7  11    3  119   48
4 ASN00086282 1970     7  12    0  112   56
5 ASN00086282 1970     7  13    5  126   51
6 ASN00086282 1970     7  14    0  112   36
```

---


```r
melbtemp %&gt;% 
  gather(day, value, V1:V31) %&gt;%
  mutate(day = sub("V", "", day)) %&gt;%
  mutate(value=ifelse(value==-9999, NA, value)) %&gt;%
  filter(var %in% c("PRCP", "TMAX", "TMIN")) %&gt;%
  spread(var, value) %&gt;%
  mutate(PRCP=PRCP/10, TMAX=TMAX/10, TMIN=TMIN/10) %&gt;%
  head()
           id year month day PRCP TMAX TMIN
1 ASN00086282 1970     7   1  0.3 14.1  8.0
2 ASN00086282 1970     7  10  2.3 10.8  4.2
3 ASN00086282 1970     7  11  0.3 11.9  4.8
4 ASN00086282 1970     7  12  0.0 11.2  5.6
5 ASN00086282 1970     7  13  0.5 12.6  5.1
6 ASN00086282 1970     7  14  0.0 11.2  3.6
```

---
# Melbourne max temperatures

&lt;img src="2.data.organisation_files/figure-html/unnamed-chunk-24-1.png" style="display: block; margin: auto;" /&gt;

---
class: inverse middle 
# Your turn

Tidy the tuberculosis data (example 4) so that it looks like this:

```
   iso2  year gender   age count
1    AD  1989      m  1524    NA
2    AD  1990      m  1524    NA
3    AD  1991      m  1524    NA
4    AD  1992      m  1524    NA
5    AD  1993      m  1524    NA
6    AD  1994      m  1524    NA
...
```

![](lorikeets.png)


---
class: inverse middle 
# Your turn

Tidy the pew survey data (example 5) so that it looks like:

```
            religion income count
1           Agnostic  &lt;$10k    27
2            Atheist  &lt;$10k    12
3           Buddhist  &lt;$10k    27
4           Catholic  &lt;$10k   418
5 Don’t know/refused  &lt;$10k    15
6   Evangelical Prot  &lt;$10k   575
...
```

![](lorikeets.png)

---
# Wrangling your data: Verbs

- Filter
- Arrange
- Select
- Mutate
- Summarise
- Group/Ungroup

---
# Filter

Pick observations by their values. For example, 

```
filter(var %in% c("PRCP", "TMAX", "TMIN"))
```

took the column named `var` and keeps rows that have one of three values `PRCP`, `TMAX`, `TMIN`. All other rows are removed. 


---
# Arrange

Orders a data frame or tibble by the values in one column


```r
library(lubridate)
ordered_nelbtemp &lt;- melbtemp %&gt;% 
  mutate(date=ymd(paste(year, month, day, sep="-"))) %&gt;%
  arrange(date)
```

---
# Select

Choose some of the __variables__.


```r
airport &lt;- read_csv("data/airports.csv")
airport
# A tibble: 13,094 x 29
   AIRPORT_SEQ_ID AIRPORT_ID AIRPORT     DISPLAY_AIRPORT_NAME
            &lt;int&gt;      &lt;int&gt;   &lt;chr&gt;                    &lt;chr&gt;
 1        1000101      10001     01A     Afognak Lake Airport
 2        1000301      10003     03A  Bear Creek Mining Strip
 3        1000401      10004     04A          Lik Mining Camp
 4        1000501      10005     05A     Little Squaw Airport
 5        1000601      10006     06A             Kizhuyak Bay
 6        1000701      10007     07A    Klawock Seaplane Base
 7        1000801      10008     08A Elizabeth Island Airport
 8        1000901      10009     09A          Augustin Island
 9        1001001      10010     1B1          Columbia County
10        1001002      10010     1B1          Columbia County
# ... with 13,084 more rows, and 25 more variables:
#   DISPLAY_AIRPORT_CITY_NAME_FULL &lt;chr&gt;, AIRPORT_WAC &lt;int&gt;,
#   AIRPORT_COUNTRY_NAME &lt;chr&gt;, AIRPORT_COUNTRY_CODE_ISO &lt;chr&gt;,
#   AIRPORT_STATE_NAME &lt;chr&gt;, AIRPORT_STATE_CODE &lt;chr&gt;,
#   AIRPORT_STATE_FIPS &lt;chr&gt;, CITY_MARKET_ID &lt;int&gt;,
#   DISPLAY_CITY_MARKET_NAME_FULL &lt;chr&gt;, CITY_MARKET_WAC &lt;int&gt;,
#   LAT_DEGREES &lt;int&gt;, LAT_HEMISPHERE &lt;chr&gt;, LAT_MINUTES &lt;int&gt;,
#   LAT_SECONDS &lt;int&gt;, LATITUDE &lt;dbl&gt;, LON_DEGREES &lt;int&gt;,
#   LON_HEMISPHERE &lt;chr&gt;, LON_MINUTES &lt;int&gt;, LON_SECONDS &lt;int&gt;,
#   LONGITUDE &lt;dbl&gt;, AIRPORT_START_DATE &lt;date&gt;, AIRPORT_THRU_DATE &lt;date&gt;,
#   AIRPORT_IS_CLOSED &lt;int&gt;, AIRPORT_IS_LATEST &lt;int&gt;, X29 &lt;chr&gt;
```

---


```r
airport %&gt;%
  select(AIRPORT, LATITUDE, LONGITUDE, AIRPORT_IS_LATEST, DISPLAY_AIRPORT_NAME)
# A tibble: 13,094 x 5
   AIRPORT LATITUDE  LONGITUDE AIRPORT_IS_LATEST     DISPLAY_AIRPORT_NAME
     &lt;chr&gt;    &lt;dbl&gt;      &lt;dbl&gt;             &lt;int&gt;                    &lt;chr&gt;
 1     01A 58.10944 -152.90667                 1     Afognak Lake Airport
 2     03A 65.54806 -161.07167                 1  Bear Creek Mining Strip
 3     04A 68.08333 -163.16667                 1          Lik Mining Camp
 4     05A 67.57000 -148.18389                 1     Little Squaw Airport
 5     06A 57.74528 -152.88278                 1             Kizhuyak Bay
 6     07A 55.55472 -133.10167                 1    Klawock Seaplane Base
 7     08A 59.15694 -151.82917                 1 Elizabeth Island Airport
 8     09A 59.36278 -153.43056                 1          Augustin Island
 9     1B1 42.28889  -73.71028                 0          Columbia County
10     1B1 42.29139  -73.71028                 1          Columbia County
# ... with 13,084 more rows
```

---
# Mutate

Create new, or transform existing, variables, e.g. for the Melbourne temperature data, we put the temperature and precipitation values into Celsius and mm, byt dividing by 10.

```
mutate(PRCP=PRCP/10, TMAX=TMAX/10, TMIN=TMIN/10)
```

---
# Summarise

Calculate a quantity on a column, producing a single number, e.g. sample statistics for PRCP:


```r
melbtemp %&gt;% summarise(m = mean(PRCP, na.rm=TRUE), s = sd(PRCP, na.rm=TRUE), 
            mx = max(PRCP, na.rm=TRUE), mn = min(PRCP, na.rm=TRUE))
         m        s    mx mn
1 1.472235 4.684938 138.8  0
```

- Stats: `mean()`, `median()`, `sd()`, `min()`, `max()`, `sum()`
- Rounding: `floor()`, `ceiling()`, `trunc()`, `round()`, `signif()`

---
# Grouping and ungrouping

Summarise is most commonly called on subgroups of data. We might want to calculate statistics of the weather data across years. 


```r
melbtemp %&gt;% group_by(year) %&gt;%
  summarise(m = mean(TMAX, na.rm=TRUE), s = sd(TMAX, na.rm=TRUE), 
            mx = max(TMAX, na.rm=TRUE), mn = min(TMAX, na.rm=TRUE))
# A tibble: 45 x 5
    year        m        s    mx    mn
   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1  1970 17.65598 5.732199  36.3   6.5
 2  1971 19.44740 6.232913  38.0   9.3
 3  1972 20.09370 6.021887  39.0   8.4
 4  1973 19.27726 6.304111  39.8   6.5
 5  1974 19.23507 6.375121  36.4   8.5
 6  1975 19.51562 5.990767  39.0   6.2
 7  1976 19.42186 6.426436  41.4   7.5
 8  1977 19.38548 6.658039  40.2   8.0
 9  1978 18.78164 6.149057  38.8   8.2
10  1979 19.81260 6.663044  41.0  10.0
# ... with 35 more rows
```

If we want to more operations on the variable `year` after these calculations, you would need to do an `ungroup()` step.

---
# Melbourne max max temperature

&lt;img src="2.data.organisation_files/figure-html/unnamed-chunk-30-1.png" style="display: block; margin: auto;" /&gt;

---
# Putting it together for the french fries

10 week sensory experiment, 12 individuals assessed taste of french fries on several scales (how potato-y, buttery, grassy, rancid, paint-y do they taste?), fried in one of 3 different oils, replicated twice. First few rows:


```
# A tibble: 696 x 9
     time treatment subject   rep potato buttery grassy rancid painty
 * &lt;fctr&gt;    &lt;fctr&gt;  &lt;fctr&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1      1         1       3     1    2.9     0.0    0.0    0.0    5.5
 2      1         1       3     2   14.0     0.0    0.0    1.1    0.0
 3      1         1      10     1   11.0     6.4    0.0    0.0    0.0
 4      1         1      10     2    9.9     5.9    2.9    2.2    0.0
 5      1         1      15     1    1.2     0.1    0.0    1.1    5.1
 6      1         1      15     2    8.8     3.0    3.6    1.5    2.3
 7      1         1      16     1    9.0     2.6    0.4    0.1    0.2
 8      1         1      16     2    8.2     4.4    0.3    1.4    4.0
 9      1         1      19     1    7.0     3.2    0.0    4.9    3.2
10      1         1      19     2   13.0     0.0    3.1    4.3   10.3
# ... with 686 more rows
```

---
# What would we like to know?

- Is the design complete?
- Are replicates like each other?
- How do the ratings on the different criteria differ?
- Are raters giving different scores on average?
- Do ratings change over the weeks?

Each of these questions involves different summaries of the data.

---
# Answer some Questions

- Easiest question is whether the ratings are similar on the different scales, potato'y, buttery, grassy, rancid and painty. 
- We need to gather the data into long form, and make plots facetted by the scale. 


```r
ff.m &lt;- french_fries %&gt;% 
  gather(type, rating, -subject, -time, -treatment, -rep)
ggplot(data=ff.m, aes(x=rating)) + geom_histogram(binwidth=2) + 
  facet_wrap(~type, ncol=5) 
```

&lt;img src="2.data.organisation_files/figure-html/unnamed-chunk-32-1.png" style="display: block; margin: auto;" /&gt;

---
# Look at it a different way

&lt;img src="2.data.organisation_files/figure-html/unnamed-chunk-33-1.png" style="display: block; margin: auto;" /&gt;

---
# Comparison of the distributions of criteria

Ratings on the different criteria are quite different. 
- Potato'y scores relatively highly. 
- Grassy are mostly 0's
- Buttery and painty are skewed right, mostly low values a few high ratings
- Rancid is quite varied, we would hope that this relates to time, that the chips get more rancid as the weeks go by.

---
# Do the replicates look like each other?

- We will start to tackle this by plotting the replicates against each other using a scatterplot. 
- If raters give the same rating to the replicates, we would expect something close to this, then all values would lie on the X=Y line
- We need to 
    - gather the data into long form, and 
    - then get the replicates spread into separate columns. 

---


```r
ff.s &lt;- ff.m %&gt;% spread(rep, rating)
head(ff.s)
# A tibble: 6 x 6
    time treatment subject    type   `1`   `2`
  &lt;fctr&gt;    &lt;fctr&gt;  &lt;fctr&gt;   &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;
1      1         1       3 buttery   0.0   0.0
2      1         1       3  grassy   0.0   0.0
3      1         1       3  painty   5.5   0.0
4      1         1       3  potato   2.9  14.0
5      1         1       3  rancid   0.0   1.1
6      1         1      10 buttery   6.4   5.9
```

---
# Check Replicates

![](2.data.organisation_files/figure-html/unnamed-chunk-35-1.png)![](2.data.organisation_files/figure-html/unnamed-chunk-35-2.png)

They have some positive linear association, but there is a lot more variation than expected. One rep might have scored 15 and the other 0, that's the same batches, same oil, same criteria, same week, same rater!

---
# Separately by criteria ...


&lt;img src="2.data.organisation_files/figure-html/unnamed-chunk-36-1.png" style="display: block; margin: auto;" /&gt;

buttery and potato'y look a bit better. The rest are still terrible. 

---
# by oil ...

&lt;img src="2.data.organisation_files/figure-html/unnamed-chunk-37-1.png" style="display: block; margin: auto;" /&gt;

Not much improvement here.

---
# By subject ...

&lt;img src="2.data.organisation_files/figure-html/unnamed-chunk-38-1.png" style="display: block; margin: auto;" /&gt;

Some subjects may be more experienced than others?

---


Because the replicates do not look like each other, the quality of the data might be questioned at this point. 

Nevertheless, lets push on with some of the other questions.

---
# Completeness of experimental design

If the data is complete it should be 12 x 10 x 3 x 2, that is, 6 records for each person. (Assuming that each person rated on all scales.) 

To check this we want to tabulate the number of records for each subject, time and treatment. That is,
- select appropriate columns, 
- tabulate, 
- count and 
- spread it out to give a nice table.

---


```r
french_fries %&gt;% 
  select(subject, time, treatment) %&gt;% 
  count(subject, time) %&gt;%
  spread(time, n)
# A tibble: 12 x 11
   subject   `1`   `2`   `3`   `4`   `5`   `6`   `7`   `8`   `9`  `10`
 *  &lt;fctr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
 1       3     6     6     6     6     6     6     6     6     6    NA
 2      10     6     6     6     6     6     6     6     6     6     6
 3      15     6     6     6     6     6     6     6     6     6     6
 4      16     6     6     6     6     6     6     6     6     6     6
 5      19     6     6     6     6     6     6     6     6     6     6
 6      31     6     6     6     6     6     6     6     6    NA     6
 7      51     6     6     6     6     6     6     6     6     6     6
 8      52     6     6     6     6     6     6     6     6     6     6
 9      63     6     6     6     6     6     6     6     6     6     6
10      78     6     6     6     6     6     6     6     6     6     6
11      79     6     6     6     6     6     6     6     6     6    NA
12      86     6     6     6     6     6     6     6     6    NA     6
```

Its pretty good, but subjects, 3, 31, 79, 86 all missed a rating session. 

---
# By criteria


```
# A tibble: 12 x 11
   subject   `1`   `2`   `3`   `4`   `5`   `6`   `7`   `8`   `9`  `10`
 *  &lt;fctr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
 1       3    30    30    30    30    30    30    30    30    30    NA
 2      10    30    30    30    30    30    30    30    30    30    30
 3      15    30    30    30    30    30    30    30    30    30    30
 4      16    30    30    30    30    30    30    30    30    30    30
 5      19    30    30    30    30    30    30    30    30    30    30
 6      31    30    30    30    30    30    30    30    30    NA    30
 7      51    30    30    30    30    30    30    30    30    30    30
 8      52    30    30    30    30    30    30    30    30    30    30
 9      63    30    30    30    30    30    30    30    30    30    30
10      78    30    30    30    30    30    30    30    30    30    30
11      79    30    30    30    30    30    30    30    30    30    NA
12      86    30    30    30    30    30    30    30    30    NA    30
```

---
# Change in rancid ratings over weeks

- Filter on criteria
- Compute means by subject, week and oil


```r
ff.av &lt;- ff.m %&gt;% 
  filter(type == "rancid") %&gt;%
  group_by(subject, time, treatment) %&gt;%
  summarise(rating=mean(rating))
```

---

&lt;img src="2.data.organisation_files/figure-html/unnamed-chunk-42-1.png" style="display: block; margin: auto;" /&gt;

Oh, its awful data! Only subject 86 is seeing the chips get more rancid over time, with maybe oil 1 being worse. Subject 63, shows some trend. Nothing is rancid for subjects 78, 79. Subject 53 thinks they taste better after many weeks in the same old oil!

---
class: inverse middle 
# Your turn

For the 2015 OECD PISA data, Australia subset, strip the state out of the STRATUM variable using this code:


```r
load("data/pisa_au.rda")
pisa_au &lt;- pisa_au %&gt;% mutate(state=as.character(substr(STRATUM, 4, 5)),
                schtype_yr=as.character(substr(STRATUM, 6, 7))) %&gt;%
  mutate(state=recode(state, "01"="ACT", "02"="NSW", "03"="VIC",
       "04"="QLD", "05"="SA", "06"="WA", "07"="TAS", "08"="NT"))
```

use your wrangling skills to answer these questions:

- Compute the average of math scores by state. Which state does best, on average, on math? (You should use the stuweight variable to compute a weighted average. This is survey data, and the weights indicate how representative that individual is of the population.)
- Compute the difference in average male and female math scores by state. Which state has the smallest average gender difference?
- Does test anxiety have an effect math score?

---
# Summary

- Tidy data is a conceptual framework that helps to be more efficient in data analysis
- Most analysis tasks can be accomplished using the handful of wrangling verbs
- Its worth learning!

---
# Resources

- Data transformation [cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/source/pdfs/data-transformation-cheatsheet.pdf)
- [Wickham (2007) Reshaping data](https://www.jstatsoft.org/article/view/v021i12/v21i12.pdf)
- [Wickham (2011) Split-Apply-Combine](https://www.jstatsoft.org/article/view/v040i01)
- [broom vignettes, David Robinson](https://cran.r-project.org/web/packages/broom/vignettes/broom.html)

---
class: inverse middle 
# Share and share alike

This work is licensed under the Creative Commons Attribution-Noncommercial 3.0 United States License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc/3.0/us/ or send a letter to Creative Commons, 171 Second Street, Suite 300, San Francisco, California, 94105, USA.
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {window.dispatchEvent(new Event('resize'));});</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
